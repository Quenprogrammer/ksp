 <!-- catalog.component.html -->
<main class="content-wrapper">
  <!-- Breadcrumb -->
  <nav class="container pt-2 pt-xxl-3 my-3 my-md-4" aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a routerLink="/home">Home</a></li>
      <li class="breadcrumb-item active" aria-current="page">Catalog with sidebar filters</li>
    </ol>
  </nav>

  <!-- Page title -->
  <h1 class="h3 container pb-3 pb-lg-4">Shop catalog</h1>

  <!-- Products grid + Sidebar with filters -->
  <section class="container">
    <div class="row">
      <!-- Mobile sidebar toggle -->
      <div class="col-12 d-lg-none mb-3">
        <button class="btn btn-outline-secondary w-100" (click)="toggleSidebar()">
          <i class="ci-filter me-2"></i> Filter Products
        </button>
      </div>

      <!-- Filter sidebar -->
      <aside class="col-lg-3" [class.d-none]="isSidebarOpen ? false : true"
             [class.d-lg-block]="true"
             [@slideInOut]="isSidebarOpen ? 'in' : 'out'"
             #sidebar>
        <div class="pe-lg-4">
          <div class="py-3 d-flex d-lg-none align-items-center justify-content-between">
            <h5 class="mb-0">Filter products</h5>
            <button type="button" class="btn-close" (click)="closeSidebar()" aria-label="Close"></button>
          </div>

          <div class="pt-2 py-lg-0">
            <!-- Selected filters -->
            <div class="pb-4 mb-2 mb-xl-3">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h4 class="h6 mb-0">Filter</h4>
                <button type="button" class="btn btn-sm btn-secondary bg-transparent border-0 text-decoration-underline p-0 ms-2"
                        (click)="clearAllFilters()">
                  Clear all
                </button>
              </div>
              <div class="d-flex flex-wrap gap-2" *ngIf="activeFilters.length > 0">
                <button type="button" class="btn btn-sm btn-secondary"
                        *ngFor="let filter of activeFilters"
                        (click)="removeFilter(filter)">
                  <i class="ci-close fs-sm ms-n1 me-1"></i>
                  {{filter}}
                </button>
              </div>
              <div class="text-muted small" *ngIf="activeFilters.length === 0">
                No filters applied
              </div>
            </div>

            <!-- Categories Accordion -->
            <div class="filter-section border-bottom pb-3 mb-3">
              <button class="filter-header w-100 text-start p-0 pb-2 d-flex justify-content-between align-items-center border-0 bg-transparent"
                      (click)="toggleAccordion('categories')">
                <span class="fw-medium">Categories</span>
                <i class="ci-chevron-down" [class.ci-chevron-up]="accordionStates.categories"></i>
              </button>
              <div [@expandCollapse]="accordionStates.categories ? 'expanded' : 'collapsed'">
                <div class="pt-2" style="max-height: 220px; overflow-y: auto;">
                  <!-- Option 1: Using getter methods -->
                  <div class="form-check mb-2" *ngFor="let category of categories; let i = index">
                    <input type="checkbox" class="form-check-input"
                           [id]="'cat-' + category.id"
                           [formControl]="getCategoryControl(i)">
                    <label [for]="'cat-' + category.id" class="form-check-label d-flex justify-content-between">
                      <span>{{category.name}}</span>
                      <span class="text-muted small">({{category.count}})</span>
                    </label>
                  </div>

                  <!-- Option 2: Using formArrayName (if you prefer) -->
                  <!--
                  <div formArrayName="categories">
                    <div class="form-check mb-2" *ngFor="let category of categories; let i = index">
                      <input type="checkbox" class="form-check-input"
                             [id]="'cat-' + category.id"
                             [formControlName]="i">
                      <label [for]="'cat-' + category.id" class="form-check-label d-flex justify-content-between">
                        <span>{{category.name}}</span>
                        <span class="text-muted small">({{category.count}})</span>
                      </label>
                    </div>
                  </div>
                  -->
                </div>
              </div>
            </div>

            <!-- Price Accordion -->
            <div class="filter-section border-bottom pb-3 mb-3">
              <button class="filter-header w-100 text-start p-0 pb-2 d-flex justify-content-between align-items-center border-0 bg-transparent"
                      (click)="toggleAccordion('price')">
                <span class="fw-medium">Price</span>
                <i class="ci-chevron-down" [class.ci-chevron-up]="accordionStates.price"></i>
              </button>
              <div [@expandCollapse]="accordionStates.price ? 'expanded' : 'collapsed'">
                <div class="pt-3">
                  <div class="d-flex align-items-center mb-3">
                    <div class="position-relative w-50">
                      <i class="ci-dollar-sign position-absolute top-50 start-0 translate-middle-y ms-3"></i>
                      <input type="number" class="form-control form-icon-start"
                             formControlName="priceMin"
                             min="0" max="200">
                    </div>
                    <i class="ci-minus text-body-emphasis mx-2"></i>
                    <div class="position-relative w-50">
                      <i class="ci-dollar-sign position-absolute top-50 start-0 translate-middle-y ms-3"></i>
                      <input type="number" class="form-control form-icon-start"
                             formControlName="priceMax"
                             min="0" max="200">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Brands Accordion -->
            <div class="filter-section border-bottom pb-3 mb-3">
              <button class="filter-header w-100 text-start p-0 pb-2 d-flex justify-content-between align-items-center border-0 bg-transparent"
                      (click)="toggleAccordion('brands')">
                <span class="fw-medium">Brands</span>
                <i class="ci-chevron-down" [class.ci-chevron-up]="accordionStates.brands"></i>
              </button>
              <div [@expandCollapse]="accordionStates.brands ? 'expanded' : 'collapsed'">
                <div class="pt-3">
                  <div class="position-relative mb-3">
                    <i class="ci-search position-absolute top-50 start-0 translate-middle-y ms-3"></i>
                    <input type="search" class="form-control form-icon-start"
                           placeholder="Search brands"
                           [(ngModel)]="brandSearch"
                           (ngModelChange)="filterBrands()">
                    <button class="btn btn-sm btn-outline-secondary w-auto border-0 p-1 position-absolute top-50 end-0 translate-middle-y me-2"
                            (click)="clearBrandSearch()"
                            *ngIf="brandSearch">
                      <i class="ci-close"></i>
                    </button>
                  </div>
                  <div style="max-height: 210px; overflow-y: auto;">
                    <!-- Option 1: Using helper method -->
                    <div class="form-check mb-2" *ngFor="let brand of filteredBrands; let i = index">
                      <input type="checkbox" class="form-check-input"
                             [id]="'brand-' + brand.id"
                             [formControl]="getBrandControl(getOriginalBrandIndex(brand.id))">
                      <label [for]="'brand-' + brand.id" class="form-check-label d-flex justify-content-between">
                        <span>{{brand.name}}</span>
                        <span class="text-muted small">({{brand.count}})</span>
                      </label>
                    </div>

                    <!-- Option 2: Simplified approach without FormArray -->
                    <!--
                    <div class="form-check mb-2" *ngFor="let brand of filteredBrands">
                      <input type="checkbox" class="form-check-input"
                             [id]="'brand-' + brand.id"
                             [checked]="selectedBrands.has(brand.id)"
                             (change)="toggleBrand(brand.id, $event)">
                      <label [for]="'brand-' + brand.id" class="form-check-label d-flex justify-content-between">
                        <span>{{brand.name}}</span>
                        <span class="text-muted small">({{brand.count}})</span>
                      </label>
                    </div>
                    -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Size Accordion -->
            <div class="filter-section border-bottom pb-3 mb-3">
              <button class="filter-header w-100 text-start p-0 pb-2 d-flex justify-content-between align-items-center border-0 bg-transparent"
                      (click)="toggleAccordion('size')">
                <span class="fw-medium">Size</span>
                <i class="ci-chevron-down" [class.ci-chevron-up]="accordionStates.size"></i>
              </button>
              <div [@expandCollapse]="accordionStates.size ? 'expanded' : 'collapsed'">
                <div class="pt-3">
                  <div class="d-flex flex-wrap gap-2">
                    <!-- Simplified approach for sizes -->
                    <div *ngFor="let size of sizes">
                      <input type="checkbox" class="btn-check"
                             [id]="'size-' + size.id"
                             [checked]="selectedSizes.has(size.id)"
                             (change)="toggleSize(size.id, $event)">
                      <label [for]="'size-' + size.id" class="btn btn-sm btn-outline-secondary">
                        {{size.label}}
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Color Accordion -->
            <div class="filter-section border-bottom pb-3 mb-3">
              <button class="filter-header w-100 text-start p-0 pb-2 d-flex justify-content-between align-items-center border-0 bg-transparent"
                      (click)="toggleAccordion('color')">
                <span class="fw-medium">Color</span>
                <i class="ci-chevron-down" [class.ci-chevron-up]="accordionStates.color"></i>
              </button>
              <div [@expandCollapse]="accordionStates.color ? 'expanded' : 'collapsed'">
                <div class="pt-3">
                  <div class="d-flex flex-column gap-2">
                    <!-- Simplified approach for colors -->
                    <div class="d-flex align-items-center mb-1" *ngFor="let color of colors">
                      <input type="checkbox" class="btn-check"
                             [id]="'color-' + color.id"
                             [checked]="selectedColors.has(color.id)"
                             (change)="toggleColor(color.id, $event)">
                      <label [for]="'color-' + color.id" class="btn btn-color fs-xl" [style.color]="color.hex"></label>
                      <label [for]="'color-' + color.id" class="fs-sm ms-2">{{color.name}}</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Status Accordion -->
            <div class="filter-section">
              <button class="filter-header w-100 text-start p-0 pb-2 d-flex justify-content-between align-items-center border-0 bg-transparent"
                      (click)="toggleAccordion('status')">
                <span class="fw-medium">Status</span>
                <i class="ci-chevron-down" [class.ci-chevron-up]="accordionStates.status"></i>
              </button>
              <div [@expandCollapse]="accordionStates.status ? 'expanded' : 'collapsed'">
                <div class="pt-3">
                  <div class="d-flex flex-column gap-2">
                    <div class="form-check mb-0">
                      <input type="checkbox" class="form-check-input" id="instock" formControlName="inStock">
                      <label for="instock" class="form-check-label">In stock</label>
                    </div>
                    <div class="form-check mb-0">
                      <input type="checkbox" class="form-check-input" id="sale" formControlName="onSale">
                      <label for="sale" class="form-check-label">% Sale</label>
                    </div>
                    <div class="form-check mb-0">
                      <input type="checkbox" class="form-check-input" id="delivery" formControlName="freeDelivery">
                      <label for="delivery" class="form-check-label">Free delivery</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Backdrop for mobile sidebar -->
      <div class="modal-backdrop fade show d-lg-none"
           [class.d-block]="isSidebarOpen"
           (click)="closeSidebar()"></div>

      <!-- Product grid -->
      <div class="col-lg-9">
        <!-- Sorting -->
        <div class="d-sm-flex align-items-center justify-content-between mt-n2 mb-3 mb-sm-4">
          <div class="fs-sm text-body-emphasis text-nowrap">
            Found <span class="fw-semibold">{{filteredProducts.length}}</span> items
          </div>
          <div class="d-flex align-items-center text-nowrap">
            <label class="form-label fw-semibold mb-0 me-2">Sort by:</label>
            <div style="width: 190px">
              <select class="form-select border-0 rounded-0 px-1" [(ngModel)]="selectedSort" (change)="sortProducts()">
                <option *ngFor="let option of sortOptions" [value]="option.value">{{option.label}}</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Products Grid -->
        <div class="row gy-4 gy-md-5 pb-4 pb-md-5">
          <div class="col-6 col-md-4 mb-2 mb-sm-3 mb-md-0"
               *ngFor="let product of filteredProducts | slice:0:displayedProducts; trackBy: trackById">
            <!-- Product Item Component -->
            <!-- <app-product-item [product]="product"></app-product-item> -->
            <!-- Or inline template -->
            <div class="product-card">
              <div class="position-relative mb-3">
                <span class="badge text-bg-danger position-absolute top-0 start-0 z-2 mt-2 mt-sm-3 ms-2 ms-sm-3"
                      *ngIf="product.sale">Sale</span>
                <a [routerLink]="['/product', product.id]" class="d-flex bg-body-tertiary rounded p-3">
                  <div class="ratio" style="--cz-aspect-ratio: calc(308 / 274 * 100%)">
                    <img [src]="product.image" [alt]="product.name" class="img-fluid">
                  </div>
                </a>
              </div>
              <div class="mb-2">
                <a [routerLink]="['/product', product.id]" class="text-dark-emphasis text-decoration-none">
                  <span class="text-truncate d-block">{{product.name}}</span>
                </a>
              </div>
              <div class="h6 mb-2">
                ${{product.price | number:'1.2-2'}}
                <del class="fs-sm fw-normal text-body-tertiary" *ngIf="product.originalPrice">
                  ${{product.originalPrice | number:'1.2-2'}}
                </del>
              </div>
            </div>
          </div>
        </div>

        <!-- Show more button -->
        <button type="button" class="btn btn-lg btn-outline-secondary w-100"
                (click)="loadMore()"
                *ngIf="displayedProducts < filteredProducts.length">
          Show more
          <i class="ci-chevron-down fs-xl ms-2 me-n1"></i>
        </button>
      </div>
    </div>
  </section>
</main>
